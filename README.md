# OCR Telegram Bot

Telegram бот для обработки PDF документов с помощью OCR (Optical Character Recognition) с использованием библиотеки Unstructured.

## Обзор проекта

Бот получает PDF файлы от пользователей, обрабатывает их через OCR и возвращает структурированный текст. Использует современный стек технологий: aiogram 3.22.0 для работы с Telegram API и Unstructured для извлечения текста из документов.

## Архитектура

### Файловая структура

```
/
├── main.py                 # Точка входа, регистрация обработчиков
├── config.py              # Настройки, токены, логирование  
├── models.py              # Pydantic модели для OCR данных
├── handlers/              # Модуль обработчиков сообщений
│   ├── __init__.py
│   ├── start.py          # Обработчик команды /start
│   ├── documents.py      # Обработка загрузки и обработки PDF
│   └── common.py         # Fallback обработчики
├── uploads/               # Папка для временных загрузок (создается автоматически)
├── result/               # Папка для результатов OCR (создается автоматически)
├── requirements.txt      # Зависимости проекта
├── .env                  # Переменные окружения (не в git)
└── README.md             # Этот файл
```

### Компоненты системы

#### 1. Точка входа (main.py)
- Инициализация бота и диспетчера aiogram
- Регистрация всех обработчиков сообщений
- Запуск polling для получения обновлений

#### 2. Конфигурация (config.py)
- Загрузка токена бота из переменных окружения
- Настройка системы логирования
- Базовые настройки приложения

#### 3. Модели данных (models.py)
Pydantic модели для структурирования OCR данных:

- **TextElement**: Элемент текста (категория, содержимое, тип)
- **PageData**: Данные одной страницы (номер, текст, элементы)
- **DocumentData**: Данные всего документа (имя файла, страницы, методы доступа)

#### 4. Обработчики (handlers/)

**start.py**: 
- Обработка команды `/start`
- Отправка приветственного сообщения с клавиатурой

**documents.py**:
- `handle_upload_document()`: Обработка нажатия кнопки "Загрузить документ"
- `handle_pdf_document()`: Основная логика OCR обработки PDF файлов
- `handle_url_document()`: Обработка PDF документов по ссылкам из облачных хранилищ
- `download_file_from_url()`: Скачивание файлов по URL
- `get_direct_download_url()`: Преобразование ссылок облачных хранилищ в прямые ссылки

**common.py**:
- Fallback обработчик для необработанных сообщений

### Процесс обработки документов

#### Прямая загрузка файла
1. **Получение файла**: Пользователь отправляет PDF документ (до 20 МБ)
2. **Скачивание**: Файл скачивается во временную папку
3. **OCR обработка**: Использование библиотеки Unstructured для извлечения текста
4. **Структурирование**: Преобразование в Pydantic модели
5. **Сохранение**: Результаты сохраняются в папку `result/` в JSON и TXT форматах
6. **Очистка**: Временный файл удаляется
7. **Возврат**: Пользователю отправляется информация о результатах

#### Загрузка по ссылке
1. **Получение ссылки**: Пользователь отправляет URL на PDF в облачном хранилище
2. **Преобразование URL**: Ссылка конвертируется в прямую ссылку для скачивания
3. **Скачивание**: Файл скачивается во временную папку через aiohttp
4. **OCR обработка**: Аналогично прямой загрузке
5. **Генерация имени**: Создается уникальное имя файла с временной меткой
6. **Сохранение и возврат**: Аналогично прямой загрузке

### Особенности реализации

#### Безопасность
- Токен бота загружается из переменных окружения
- Файлы имеют ограничения по размеру (через Telegram API)
- Временные файлы очищаются после обработки

#### Логирование
- Использование стандартного модуля `logging`
- Логи включают временные метки и уровни важности
- Отдельный логгер для каждого модуля

#### Обработка ошибок
- Корректная обработка исключений aiogram
- Информативные сообщения пользователю при ошибках
- Логирование ошибок для отладки

## Технологический стек

### Основные зависимости
- **aiogram 3.22.0**: Современная библиотека для создания Telegram ботов
- **python-dotenv 1.0.1**: Загрузка переменных окружения из .env файла
- **unstructured[pdf]**: Библиотека для OCR и извлечения структурированного текста
- **aiohttp**: Асинхронный HTTP клиент для скачивания файлов по URL
- **pydantic**: Валидация данных и создание моделей

### Python версия
Рекомендуется Python 3.8+

## Установка и запуск

### 1. Клонирование репозитория
```bash
git clone <repository-url>
cd osmi_demo_1-1
```

### 2. Создание виртуального окружения
```bash
python -m venv venv
source venv/bin/activate  # На Windows: venv\Scripts\activate
```

### 3. Установка зависимостей
```bash
pip install -r requirements.txt
```

### 4. Настройка переменных окружения
Создайте файл `.env` в корне проекта:
```env
BOT_TOKEN=ваш_токен_бота_от_BotFather
```

### 5. Запуск бота
```bash
python main.py
```

## Использование

1. Запустите бота командой `/start`
2. Нажмите кнопку "Загрузить документ"
3. Выберите способ загрузки PDF:
   - **Прямая загрузка**: Отправьте файл напрямую (до 20 МБ)
   - **Ссылка из облака**: Отправьте ссылку на файл из:
     - Google Drive
     - Dropbox
     - Яндекс.Диск
4. Получите обработанный текст и файл с результатами

### Поддержка больших файлов

Для PDF файлов размером более 20 МБ используйте облачные хранилища:

1. Загрузите PDF в Google Drive/Dropbox/Яндекс.Диск
2. Получите публичную ссылку на файл
3. Отправьте ссылку боту
4. Бот автоматически скачает и обработает файл

**Примеры поддерживаемых ссылок:**
- `https://drive.google.com/file/d/FILE_ID/view?usp=sharing`
- `https://dropbox.com/s/FILE_ID/document.pdf?dl=0`
- Прямые HTTP/HTTPS ссылки на PDF файлы

## Структура выходных данных

### JSON результат (result/*.json)
```json
{
  "filename": "document.pdf",
  "total_pages": 2,
  "pages": [
    {
      "page_number": 1,
      "full_text": "Полный текст страницы...",
      "elements": [
        {
          "category": "Title",
          "content": "Заголовок документа",
          "type": "text"
        }
      ],
      "total_elements": 5
    }
  ]
}
```

### Текстовый результат (result/*.txt)
Форматированный текст с разделением по страницам и категориям элементов.

## Разработка

### Добавление новых обработчиков
1. Создайте функцию в соответствующем модуле `handlers/`
2. Зарегистрируйте обработчик в `main.py`
3. Следуйте существующим паттернам async/await

### Расширение моделей данных
- Добавляйте новые поля в Pydantic модели в `models.py`
- Используйте типизацию и валидацию данных
- Добавляйте методы для работы с данными в классы

### Логирование
Используйте логгер из config:
```python
from config import logger
logger.info("Информационное сообщение")
logger.error("Ошибка: %s", error_message)
```